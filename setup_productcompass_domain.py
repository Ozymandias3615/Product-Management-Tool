#!/usr/bin/env python3
"""
Product Compass Domain Setup Script
Customized setup for productcompass.com domain with Mailgun
"""

import os
import requests
import time
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

DOMAIN_NAME = "productcompass.com"

def check_domain_availability():
    """Check if productcompass.com is available"""
    print(f"üîç Checking availability of {DOMAIN_NAME}...")
    
    print("\nüìù Next Steps:")
    print("1. Check domain availability at:")
    print("   ‚Ä¢ Namecheap: https://www.namecheap.com/")
    print("   ‚Ä¢ GoDaddy: https://www.godaddy.com/")
    print("   ‚Ä¢ Google Domains: https://domains.google/")
    print("\n2. Search for 'productcompass.com'")
    print("3. If available, purchase it (usually $10-15/year)")
    print("4. If not available, consider alternatives like:")
    print("   ‚Ä¢ productcompass.io")
    print("   ‚Ä¢ productcompass.app") 
    print("   ‚Ä¢ productcompass.co")
    print("   ‚Ä¢ product-compass.com")
    
    choice = input(f"\n‚ùì Do you already own {DOMAIN_NAME}? (y/n): ").lower()
    
    if choice == 'y':
        print(f"‚úÖ Great! You own {DOMAIN_NAME}")
        return True
    else:
        print(f"\nüõí Please purchase {DOMAIN_NAME} first, then run this script again.")
        print("\nüìã Recommended registrars:")
        print("‚Ä¢ Namecheap (recommended): Easy DNS management, good support")
        print("‚Ä¢ GoDaddy: Popular, user-friendly interface") 
        print("‚Ä¢ Google Domains: Clean interface, reliable")
        return False

def add_domain_to_mailgun():
    """Add productcompass.com to Mailgun"""
    
    api_key = os.getenv('MAILGUN_API_KEY')
    base_url = os.getenv('MAILGUN_BASE_URL', 'https://api.mailgun.net/v3')
    
    if not api_key:
        print("‚ùå MAILGUN_API_KEY not found in .env file")
        return False
    
    print(f"üåê Adding {DOMAIN_NAME} to Mailgun...")
    
    try:
        url = f"{base_url}/domains"
        
        data = {
            'name': DOMAIN_NAME,
            'force_dkim_authority': True,
            'dkim_key_size': 2048,
            'ips': [],
            'web_scheme': 'https'
        }
        
        response = requests.post(
            url,
            auth=('api', api_key),
            data=data,
            timeout=10
        )
        
        if response.status_code == 200:
            print("‚úÖ Domain added to Mailgun successfully!")
            return True
        elif response.status_code == 400 and "already exists" in response.text.lower():
            print("‚úÖ Domain already exists in Mailgun!")
            return True
        else:
            print(f"‚ùå Failed to add domain: {response.status_code}")
            print(f"Response: {response.text}")
            return False
            
    except Exception as e:
        print(f"‚ùå Error adding domain: {e}")
        return False

def show_dns_records():
    """Show DNS records that need to be added"""
    
    print(f"\nüìã DNS RECORDS FOR {DOMAIN_NAME.upper()}")
    print("=" * 60)
    
    print("\n1Ô∏è‚É£ SPF Record (Required)")
    print(f"   Type: TXT")
    print(f"   Name: {DOMAIN_NAME}")
    print(f"   Value: v=spf1 include:mailgun.org ~all")
    print(f"   TTL: 300")
    
    print("\n2Ô∏è‚É£ DKIM Record (Required - Get from Mailgun Dashboard)")
    print(f"   Type: TXT")
    print(f"   Name: mailo._domainkey.{DOMAIN_NAME}")
    print(f"   Value: [Copy the long DKIM key from Mailgun dashboard]")
    print(f"   TTL: 300")
    
    print(f"\nüìç WHERE TO ADD THESE RECORDS:")
    print("=" * 40)
    
    print("\nüîπ NAMECHEAP:")
    print("   1. Login to Namecheap account")
    print("   2. Go to Domain List ‚Üí Manage")
    print("   3. Click 'Advanced DNS' tab")
    print("   4. Add the TXT records above")
    
    print("\nüîπ GODADDY:")
    print("   1. Login to GoDaddy account")
    print("   2. Go to My Products ‚Üí DNS")
    print("   3. Add the TXT records above")
    
    print("\nüîπ GOOGLE DOMAINS:")
    print("   1. Login to Google Domains")
    print("   2. Select your domain")
    print("   3. Go to DNS ‚Üí Custom Records")
    print("   4. Add the TXT records above")
    
    print(f"\n‚ö†Ô∏è  IMPORTANT NOTES:")
    print("‚Ä¢ For the DKIM record, you MUST get the actual value from Mailgun")
    print("‚Ä¢ Go to https://app.mailgun.com/app/domains")
    print(f"‚Ä¢ Click on {DOMAIN_NAME}")
    print("‚Ä¢ Copy the DKIM record value (it's very long)")
    print("‚Ä¢ Some registrars only need 'mailo._domainkey' as the name")
    
    return True

def get_dkim_from_mailgun():
    """Get DKIM record from Mailgun"""
    
    api_key = os.getenv('MAILGUN_API_KEY')
    base_url = os.getenv('MAILGUN_BASE_URL', 'https://api.mailgun.net/v3')
    
    print(f"üîê Getting DKIM record for {DOMAIN_NAME}...")
    
    try:
        url = f"{base_url}/domains/{DOMAIN_NAME}"
        
        response = requests.get(
            url,
            auth=('api', api_key),
            timeout=10
        )
        
        if response.status_code == 200:
            domain_data = response.json()['domain']
            
            # Look for DKIM in the response
            for record in domain_data.get('sending_dns_records', []):
                if record.get('record_type') == 'TXT' and 'DKIM1' in record.get('value', ''):
                    print(f"\nüîê DKIM Record Found:")
                    print(f"   Name: {record.get('name', 'mailo._domainkey.' + DOMAIN_NAME)}")
                    print(f"   Value: {record.get('value', '')}")
                    return True
            
            print("‚ö†Ô∏è  DKIM record not found in API response")
            print("Please check Mailgun dashboard manually")
            return False
        else:
            print(f"‚ùå Cannot get DKIM record: {response.status_code}")
            return False
            
    except Exception as e:
        print(f"‚ùå Error getting DKIM: {e}")
        return False

def verify_dns():
    """Verify DNS records are set up correctly"""
    
    print(f"\nüîç Verifying DNS records for {DOMAIN_NAME}...")
    
    try:
        import subprocess
        
        # Check SPF record
        print("üìß Checking SPF record...")
        try:
            spf_result = subprocess.run(
                ['nslookup', '-type=TXT', DOMAIN_NAME], 
                capture_output=True, text=True, timeout=10
            )
            
            if 'mailgun.org' in spf_result.stdout:
                print("‚úÖ SPF record found!")
                spf_ok = True
            else:
                print("‚ùå SPF record not found")
                spf_ok = False
        except:
            print("‚ö†Ô∏è  Cannot verify SPF record")
            spf_ok = False
        
        # Check DKIM record
        print("üîê Checking DKIM record...")
        try:
            dkim_domain = f"mailo._domainkey.{DOMAIN_NAME}"
            dkim_result = subprocess.run(
                ['nslookup', '-type=TXT', dkim_domain], 
                capture_output=True, text=True, timeout=10
            )
            
            if 'v=DKIM1' in dkim_result.stdout:
                print("‚úÖ DKIM record found!")
                dkim_ok = True
            else:
                print("‚ùå DKIM record not found")
                dkim_ok = False
        except:
            print("‚ö†Ô∏è  Cannot verify DKIM record")
            dkim_ok = False
        
        return spf_ok and dkim_ok
        
    except Exception as e:
        print(f"‚ùå Error verifying DNS: {e}")
        return False

def check_mailgun_status():
    """Check domain status in Mailgun"""
    
    api_key = os.getenv('MAILGUN_API_KEY')
    base_url = os.getenv('MAILGUN_BASE_URL', 'https://api.mailgun.net/v3')
    
    print(f"üìä Checking Mailgun status for {DOMAIN_NAME}...")
    
    try:
        url = f"{base_url}/domains/{DOMAIN_NAME}"
        
        response = requests.get(
            url,
            auth=('api', api_key),
            timeout=10
        )
        
        if response.status_code == 200:
            domain_info = response.json()['domain']
            state = domain_info.get('state', 'unknown')
            
            print(f"üìç Domain: {DOMAIN_NAME}")
            print(f"üìä Status: {state}")
            
            if state == 'active':
                print("üéâ Domain is verified and active!")
                return True
            else:
                print(f"‚è≥ Domain status: {state}")
                return False
        else:
            print(f"‚ùå Cannot check status: {response.status_code}")
            return False
            
    except Exception as e:
        print(f"‚ùå Error checking status: {e}")
        return False

def update_env_file():
    """Update .env file with productcompass.com"""
    
    print(f"üìù Updating .env file for {DOMAIN_NAME}...")
    
    try:
        # Read current .env file
        with open('.env', 'r') as f:
            lines = f.readlines()
        
        # Update relevant lines
        updated_lines = []
        domain_updated = False
        mail_updated = False
        
        for line in lines:
            if line.startswith('MAILGUN_DOMAIN='):
                updated_lines.append(f'MAILGUN_DOMAIN={DOMAIN_NAME}\n')
                domain_updated = True
            elif line.startswith('MAIL_FROM_ADDRESS='):
                updated_lines.append(f'MAIL_FROM_ADDRESS=noreply@{DOMAIN_NAME}\n')
                mail_updated = True
            else:
                updated_lines.append(line)
        
        # Add lines if they don't exist
        if not domain_updated:
            updated_lines.append(f'MAILGUN_DOMAIN={DOMAIN_NAME}\n')
        if not mail_updated:
            updated_lines.append(f'MAIL_FROM_ADDRESS=noreply@{DOMAIN_NAME}\n')
        
        # Write back to .env file
        with open('.env', 'w') as f:
            f.writelines(updated_lines)
        
        print("‚úÖ .env file updated successfully!")
        print(f"üìß Email from address: noreply@{DOMAIN_NAME}")
        return True
        
    except Exception as e:
        print(f"‚ùå Error updating .env file: {e}")
        return False

def send_test_email():
    """Send a test email to verify everything works"""
    
    print(f"\nüß™ Testing email delivery from {DOMAIN_NAME}...")
    
    test_email = input("üìß Enter your email to receive a test message: ").strip()
    
    if not test_email or '@' not in test_email:
        print("‚ùå Invalid email address")
        return False
    
    # Use the send_mailgun_email function from app.py
    try:
        from app import send_mailgun_email
        
        subject = f"‚úÖ Test Email from {DOMAIN_NAME}"
        html_content = f"""
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
            <h1 style="color: #0056d2;">üéâ Success!</h1>
            <p>This is a test email from your new custom domain: <strong>{DOMAIN_NAME}</strong></p>
            <p>‚úÖ Domain is properly configured</p>
            <p>‚úÖ Mailgun integration working</p>
            <p>‚úÖ DNS records verified</p>
            <p>‚úÖ Professional email delivery achieved!</p>
            <hr>
            <p style="color: #666; font-size: 14px;">
                This email was sent from Product Compass using your custom domain.
            </p>
        </div>
        """
        
        success, error = send_mailgun_email(
            to_email=test_email,
            subject=subject,
            html_content=html_content
        )
        
        if success:
            print("‚úÖ Test email sent successfully!")
            print(f"üì¨ Check your inbox at {test_email}")
            print("üìä Check spam folder if you don't see it immediately")
            return True
        else:
            print(f"‚ùå Test email failed: {error}")
            return False
            
    except Exception as e:
        print(f"‚ùå Error sending test email: {e}")
        return False

def main():
    """Main setup function for productcompass.com"""
    
    print("üöÄ Product Compass Domain Setup")
    print(f"üéØ Setting up: {DOMAIN_NAME}")
    print("=" * 50)
    
    # Step 1: Check domain ownership
    print("\n" + "="*50)
    print("STEP 1: Domain Ownership")
    print("="*50)
    
    if not check_domain_availability():
        return
    
    # Step 2: Add to Mailgun
    print("\n" + "="*50)
    print("STEP 2: Adding to Mailgun")
    print("="*50)
    
    if not add_domain_to_mailgun():
        print("‚ùå Cannot proceed without adding domain to Mailgun")
        return
    
    # Step 3: Show DNS records
    print("\n" + "="*50)
    print("STEP 3: DNS Configuration")
    print("="*50)
    
    show_dns_records()
    
    # Try to get DKIM from Mailgun API
    print("\nüîç Attempting to get DKIM record from Mailgun...")
    get_dkim_from_mailgun()
    
    # Wait for user to add DNS records
    input("\n‚è∏Ô∏è  Press Enter AFTER you've added both TXT records to your domain...")
    
    # Step 4: Verify DNS
    print("\n" + "="*50)
    print("STEP 4: DNS Verification")
    print("="*50)
    
    print("‚è∞ Waiting 30 seconds for DNS propagation...")
    time.sleep(30)
    
    dns_ok = verify_dns()
    
    if not dns_ok:
        print("\n‚ö†Ô∏è  DNS verification failed.")
        retry = input("üîÑ Wait more and try again? (y/n): ").lower()
        if retry == 'y':
            print("‚è∞ Waiting 60 more seconds...")
            time.sleep(60)
            dns_ok = verify_dns()
    
    # Step 5: Check Mailgun status
    print("\n" + "="*50)
    print("STEP 5: Mailgun Verification")
    print("="*50)
    
    mailgun_ok = check_mailgun_status()
    
    # Step 6: Update .env file
    print("\n" + "="*50)
    print("STEP 6: Update Configuration")
    print("="*50)
    
    update_env_file()
    
    # Step 7: Test everything
    if mailgun_ok:
        print("\n" + "="*50)
        print("STEP 7: Final Test")
        print("="*50)
        
        send_test_email()
    
    # Final status
    print("\n" + "="*60)
    print("üèÅ SETUP COMPLETE!")
    print("="*60)
    
    if mailgun_ok:
        print("‚úÖ Domain added to Mailgun")
        print("‚úÖ DNS records configured")
        print("‚úÖ Domain verified and active")
        print("‚úÖ .env file updated")
        print("\nüéâ CONGRATULATIONS!")
        print(f"üìß Your emails will now be sent from: noreply@{DOMAIN_NAME}")
        print("üìà You now have professional email deliverability!")
        print("üß™ Test your contact form to see the difference!")
        
        print(f"\nüìä Expected improvements:")
        print("‚Ä¢ üìà 90%+ inbox delivery rate (vs 30% with sandbox)")
        print("‚Ä¢ üìß 10,000 emails/month (vs 300 with sandbox)")
        print("‚Ä¢ üåü Professional sender reputation")
        print("‚Ä¢ üö´ No more authorized recipients restriction")
    else:
        print("\n‚ö†Ô∏è  Setup incomplete. Next steps:")
        print("1. Double-check DNS records are correct")
        print("2. Wait 30 minutes for full DNS propagation")
        print("3. Check Mailgun dashboard for verification status")
        print("4. Run this script again to test")

if __name__ == "__main__":
    main() 